# Reporte de proyecto

## Estructura del proyecto

```
/home/fabiana/tests
├── Módulo de Autenticación y Registro
│   ├── login.php
│   ├── logout.php
│   ├── registro.php
│   └── restablecer.php
├── Módulo de Gestión de Entradas (El Diario)
│   ├── actualizar_entrada.php
│   ├── borrar.php
│   ├── editar_accion.php
│   └── guardar_entrada.php
├── Módulo de Perfil y Administración
│   ├── actualizar_perfil.php
│   └── cambiar_rol.php
├── generar_reporte.py
└── reporte
```

## Código (intercalado)

# tests
**generar_reporte.py**
```python
#!/usr/bin/env python3
import os
import sys
import argparse
from datetime import datetime

# =========================
# Configuración mínima
# =========================
EXTENSIONES_PERMITIDAS = (
    ".html", ".css", ".js", ".php", ".py", ".java", ".sql",
    ".c", ".cpp", ".cu", ".h", ".json", ".xml", ".md"
)
CARPETAS_EXCLUIDAS = {
    ".git", "node_modules", "vendor", "venv", "__pycache__",
    "modelo_entrenado", ".venv"
}

LANG_MAP = {
    ".html": "html", ".css": "css", ".js": "js", ".php": "php",
    ".py": "python", ".java": "java", ".sql": "sql", ".c": "c",
    ".cpp": "cpp", ".cu": "cuda", ".h": "c", ".json": "json",
    ".xml": "xml", ".md": "markdown",
}

# =========================
# Utilidades
# =========================
def construir_mapa_directorios(ruta_raiz: str) -> str:
    """Devuelve un árbol de directorios estilo 'tree', excluyendo carpetas no deseadas."""
    lineas = []
    raiz_abs = os.path.abspath(ruta_raiz)
    lineas.append(raiz_abs)

    def interno(dir_path: str, prefijo: str = ""):
        try:
            entradas = sorted(os.listdir(dir_path))
        except Exception:
            return
        # Filtra carpetas excluidas
        entradas_visibles = []
        for e in entradas:
            full = os.path.join(dir_path, e)
            if os.path.isdir(full) and e in CARPETAS_EXCLUIDAS:
                continue
            entradas_visibles.append(e)

        for i, entrada in enumerate(entradas_visibles):
            ruta_completa = os.path.join(dir_path, entrada)
            conector = "└── " if i == len(entradas_visibles) - 1 else "├── "
            lineas.append(prefijo + conector + entrada)
            if os.path.isdir(ruta_completa):
                extension = "    " if i == len(entradas_visibles) - 1 else "│   "
                interno(ruta_completa, prefijo + extension)

    interno(ruta_raiz)
    return "\n".join(lineas)


def generar_reporte_intercalado(ruta_raiz: str, nivel: int = 1) -> str:
    """
    Recorre la carpeta y, para cada archivo con extensión permitida,
    inserta su contenido en un bloque de código Markdown.
    """
    encabezado = "#" * nivel
    nombre_carpeta = os.path.basename(ruta_raiz) or ruta_raiz
    lineas = [f"{encabezado} {nombre_carpeta}"]

    try:
        entradas = sorted(os.listdir(ruta_raiz))
    except Exception as e:
        lineas.append(f"Error listando la carpeta: {e}")
        return "\n".join(lineas)

    # Archivos de este nivel
    for entrada in entradas:
        ruta_completa = os.path.join(ruta_raiz, entrada)
        if os.path.isfile(ruta_completa) and entrada.lower().endswith(EXTENSIONES_PERMITIDAS):
            ext = os.path.splitext(entrada)[1].lower()
            lang = LANG_MAP.get(ext, "")
            lineas.append(f"**{entrada}**")
            try:
                with open(ruta_completa, "r", encoding="utf-8", errors="ignore") as f:
                    contenido = f.read()
            except Exception as e:
                contenido = f"Error al leer el archivo: {e}"
            lineas.append(f"```{lang}")
            lineas.append(contenido)
            lineas.append("```")

    # Subcarpetas (excluyendo las no deseadas)
    for entrada in entradas:
        ruta_completa = os.path.join(ruta_raiz, entrada)
        if os.path.isdir(ruta_completa) and entrada not in CARPETAS_EXCLUIDAS:
            lineas.append(generar_reporte_intercalado(ruta_completa, nivel + 1))

    return "\n".join(lineas)


def generar_reporte(ruta_origen: str) -> str:
    """
    Genera el contenido completo del reporte en Markdown:
    - Árbol de directorios
    - Código intercalado
    """
    arbol = construir_mapa_directorios(ruta_origen)
    intercalado = generar_reporte_intercalado(ruta_origen)

    partes = []
    partes.append("# Reporte de proyecto\n")
    partes.append("## Estructura del proyecto\n")
    partes.append("```\n" + arbol + "\n```\n")
    partes.append("## Código (intercalado)\n")
    partes.append(intercalado)
    return "\n".join(partes)


# =========================
# CLI
# =========================
def main():
    parser = argparse.ArgumentParser(
        description="Genera un reporte Markdown de una carpeta de código (árbol + contenidos)."
    )
    parser.add_argument("source_root", help="Carpeta origen a inspeccionar")
    parser.add_argument("dest_folder", help="Carpeta destino donde guardar el reporte")
    args = parser.parse_args()

    source_root = os.path.abspath(args.source_root)
    dest_folder = os.path.abspath(args.dest_folder)

    if not os.path.isdir(source_root):
        print(f"[ERROR] La carpeta origen no existe o no es un directorio: {source_root}", file=sys.stderr)
        sys.exit(1)

    os.makedirs(dest_folder, exist_ok=True)

    base_name = os.path.basename(source_root.rstrip(os.sep)) or "reporte"
    timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
    out_name = f"{base_name}_{timestamp}.md"
    out_path = os.path.join(dest_folder, out_name)

    try:
        contenido = generar_reporte(source_root)
        with open(out_path, "w", encoding="utf-8") as f:
            f.write(contenido)
    except KeyboardInterrupt:
        print("\n[INTERRUPT] Proceso cancelado por el usuario.", file=sys.stderr)
        sys.exit(130)
    except Exception as e:
        print(f"[ERROR] No se pudo generar o guardar el reporte: {e}", file=sys.stderr)
        sys.exit(2)

    print(f"[OK] Reporte generado: {out_path}")


if __name__ == "__main__":
    main()


```
## Módulo de Autenticación y Registro
**login.php**
```php
<?php
// --- CONFIGURACIÓN DE ERRORES ---
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();
require_once '../config/conexion.php';

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // 1. Limpieza de entradas
    $credencial = trim($_POST['credencial']); 
    $pass = $_POST['password'];

    // 2. Validación rápida de campos vacíos
    if (empty($credencial) || empty($pass)) {
        header("Location: ../pages/index.php?error=vacios");
        exit();
    }

    try {
        // 3. Consulta preparada para buscar por Email o Nombre (Username)
        $sql = "SELECT id, nombre, password, rol FROM usuarios WHERE email = ? OR nombre = ? LIMIT 1";
        $stmt = $conexion->prepare($sql);
        $stmt->bind_param("ss", $credencial, $credencial);
        $stmt->execute();
        $res = $stmt->get_result();

        if ($fila = $res->fetch_assoc()) {
            // 4. Verificación de la contraseña encriptada
            if (password_verify($pass, $fila['password'])) {
                
                // Login Correcto: Generamos la sesión
                $_SESSION['usuario_id'] = $fila['id'];
                $_SESSION['usuario_nombre'] = $fila['nombre'];
                $_SESSION['rol'] = $fila['rol'];
                
                // 5. Actualizar última conexión (con sentencia preparada por seguridad)
                $update_sql = "UPDATE usuarios SET ultima_conexion = NOW() WHERE id = ?";
                $stmt_upd = $conexion->prepare($update_sql);
                $stmt_upd->bind_param("i", $fila['id']);
                $stmt_upd->execute();
                
                // Redirigir al Dashboard
                header("Location: ../pages/dashboard.php");
                exit();
            }
        }
        
        // 6. Si llega aquí, es que el usuario no existe o la contraseña no coincide
        header("Location: ../pages/index.php?error=credenciales");
        exit();

    } catch (Exception $e) {
        // Error de base de datos
        die("Error en el sistema: " . $e->getMessage());
    }
}

```
**logout.php**
```php
<?php
session_start();
require_once '../config/conexion.php';

if (isset($_SESSION['usuario_id'])) {
    $uid = $_SESSION['usuario_id'];
    $conexion->query("UPDATE usuarios SET ultima_conexion = '2000-01-01 00:00:00' WHERE id = $uid");
}

session_unset();
session_destroy();
header("Location: ../pages/index.php");
exit();
?>

```
**registro.php**
```php
<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();

$ruta_conexion = '../config/conexion.php';
if (!file_exists($ruta_conexion)) {
    die("❌ Error Fatal: No encuentro el archivo de conexión.");
}
require_once $ruta_conexion;

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // 1. Recoger y limpiar datos
    $nombre = trim($_POST['nombre']);
    $email = trim($_POST['email']);
    $pass = $_POST['password']; // <-- Faltaba definir esta variable

    // Guardar datos en sesión para el formulario sticky
    $_SESSION['datos_registro'] = $_POST;

    // 2. Validar campos vacíos
    if (empty($nombre) || empty($email) || empty($pass)) {
        header("Location: ../pages/registro_vista.php?error=vacios");
        exit();
    }

    // 3. Validar requisitos de contraseña (Regex)
    $patron = '/^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/';
    if (!preg_match($patron, $pass)) {
        header("Location: ../pages/registro_vista.php?error=password_debil");
        exit();
    }

    // 4. Lógica de Base de Datos
    try {
        // A. Verificar si ya existe el correo o el nombre
        $stmt = $conexion->prepare("SELECT id FROM usuarios WHERE email = ? OR nombre = ?");
        if (!$stmt) throw new Exception("Error en prepare (Select): " . $conexion->error);
        
        $stmt->bind_param("ss", $email, $nombre);
        $stmt->execute();
        
        if ($stmt->get_result()->num_rows > 0) {
            header("Location: ../pages/registro_vista.php?error=existe");
            exit();
        }

        // B. Encriptar contraseña
        $pass_hash = password_hash($pass, PASSWORD_DEFAULT);
        
        // C. Insertar usuario
        $query_insert = "INSERT INTO usuarios (nombre, email, password, rol) VALUES (?, ?, ?, 'user')";
        
        $insert = $conexion->prepare($query_insert);
        if (!$insert) throw new Exception("Error en prepare (Insert): " . $conexion->error);
        
        $insert->bind_param("sss", $nombre, $email, $pass_hash);

        if ($insert->execute()) {
            // SI EL REGISTRO TIENE ÉXITO:
            unset($_SESSION['datos_registro']); // Limpiamos los datos sticky
            header("Location: ../pages/index.php?registro=exito");
            exit();
        } else {
            throw new Exception("Error al ejecutar registro.");
        }

    } catch (Exception $e) {
        die("<div style='color:red; font-family:sans-serif; padding:20px; border:2px solid red;'>
                <h3>⚠️ Error Detectado:</h3>
                <p><strong>Solución probable:</strong> Revisa que tu tabla 'usuarios' tenga las columnas: nombre, email, password, rol y fecha_creacion.</p>
             </div>");
    }
}
?>

```
**restablecer.php**
```php
<?php
require_once '../config/conexion.php';
$paso = 1; // Paso 1: Verificar correo | Paso 2: Cambiar contraseña
$email = "";
$error = "";
$mensaje = "";

// 1. SI VENIMOS DE OLVIDE_PASSWORD (POST)
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['email_recuperacion'])) {
    $email = $_POST['email_recuperacion'];
    
    // Verificar si existe el email
    $stmt = $conexion->prepare("SELECT id FROM usuarios WHERE email = ?");
    $stmt->bind_param("s", $email);
    $stmt->execute();
    $res = $stmt->get_result();

    if ($res->num_rows > 0) {
        $paso = 2; // Email encontrado, mostrar formulario de cambio
    } else {
        header("Location: olvide_password.php?error=noexiste");
        exit();
    }
}

// 2. SI VENIMOS DE CAMBIAR LA CONTRASEÑA (POST FINAL)
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['nueva_pass'])) {
    $email_final = $_POST['email_hidden'];
    $pass = $_POST['nueva_pass'];
    
    // Encriptar y guardar
    $pass_hash = password_hash($pass, PASSWORD_DEFAULT);
    $stmt = $conexion->prepare("UPDATE usuarios SET password = ? WHERE email = ?");
    $stmt->bind_param("ss", $pass_hash, $email_final);
    
    if($stmt->execute()) {
        header("Location: index.php?registro=exito"); // Reusamos el mensaje de éxito
        exit();
    } else {
        $error = "Hubo un error al actualizar.";
    }
}
?>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer - Lumina</title>
    <link rel="stylesheet" href="../assets/css/estilos.css">
</head>
<body>
    <div class="login-container fade-in">
        <div class="logo-area">
            <img src="../assets/img/luminalogo.png" alt="Logo Lumina" class="logo-circular" style="width:100px; height:100px;">
            <h2>Nueva Contraseña</h2>
        </div>

        <?php if($error): ?>
            <p style="color:red; text-align:center;"><?= $error ?></p>
        <?php endif; ?>

        <?php if ($paso == 2): ?>
            <p style="text-align:center; color:#5a189a; margin-bottom:15px;">
                Hola, hemos encontrado tu cuenta: <br><strong><?= htmlspecialchars($email) ?></strong>
            </p>

            <form action="restablecer.php" method="POST">
                <input type="hidden" name="email_hidden" value="<?= htmlspecialchars($email) ?>">
                <input type="password" name="nueva_pass" placeholder="Escribe tu nueva contraseña" required>
                <button type="submit">Guardar Nueva Contraseña</button>
            </form>
        <?php else: ?>
            <p style="text-align:center;">Acceso inválido.</p>
            <a href="index.php" style="display:block; text-align:center; margin-top:15px;">Volver</a>
        <?php endif; ?>
    </div>
</body>
</html>

```
## Módulo de Gestión de Entradas (El Diario)
**actualizar_entrada.php**
```php
<?php
// --- MODO DEPURACIÓN ---
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();
require_once '../config/conexion.php';

if (!isset($_SESSION['usuario_id'])) { header("Location: ../pages/index.php"); exit(); }

if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $uid = $_SESSION['usuario_id'];
    $id_entrada = $_POST['id_entrada'];
    
    // Datos nuevos
    $emociones = $_POST["emocion"] ?? []; 
    $nota = trim($_POST["nota"]);
    $intensidad = $_POST["intensidad"];

    if (empty($emociones)) {
        // Si desmarcó todo, volvemos atrás con error
        header("Location: ../pages/editar_vista.php?id=$id_entrada&error=falta_emocion");
        exit();
    }

    try {
        // PASO 1: Obtener la FECHA ORIGINAL del registro que vamos a borrar
        // (Para que al editar no se cambie la fecha a "ahora mismo")
        $stmt_fecha = $conexion->prepare("SELECT fecha FROM entradas WHERE id = ? AND usuario_id = ?");
        $stmt_fecha->bind_param("ii", $id_entrada, $uid);
        $stmt_fecha->execute();
        $res = $stmt_fecha->get_result();
        
        if ($res->num_rows === 0) { die("Entrada no encontrada o permiso denegado."); }
        $fecha_original = $res->fetch_assoc()['fecha'];

        // PASO 2: BORRAR el registro viejo
        $stmt_borrar = $conexion->prepare("DELETE FROM entradas WHERE id = ?");
        $stmt_borrar->bind_param("i", $id_entrada);
        $stmt_borrar->execute();

        // PASO 3: INSERTAR las nuevas emociones con la FECHA VIEJA
        $sql_insert = "INSERT INTO entradas (usuario_id, emocion, nota, intensidad, fecha) VALUES (?, ?, ?, ?, ?)";
        $stmt_insert = $conexion->prepare($sql_insert);

        foreach ($emociones as $una_emocion) {
            // "issis" -> int, string, string, int, string(fecha)
            $stmt_insert->bind_param("issis", $uid, $una_emocion, $nota, $intensidad, $fecha_original);
            if (!$stmt_insert->execute()) {
                throw new Exception("Error al re-insertar: " . $stmt_insert->error);
            }
        }

        // Éxito: Volver al historial
        header("Location: ../pages/historial.php");

    } catch (Exception $e) {
        die("Error crítico: " . $e->getMessage());
    }
}
?>

```
**borrar.php**
```php
<?php
session_start();
require_once '../config/conexion.php';

if (!isset($_SESSION['usuario_id'])) { header("Location: ../pages/index.php"); exit(); }

$mi_id = $_SESSION['usuario_id'];
$id_entrada = $_GET['id'] ?? null;

if ($id_entrada) {
    // Verificar rol actual
    $check_rol = $conexion->query("SELECT rol FROM usuarios WHERE id = $mi_id");
    $soy_admin = ($check_rol->fetch_assoc()['rol'] === 'admin');

    if ($soy_admin) {
        // ADMIN: Puede borrar cualquier entrada (incluso de otros)
        $stmt = $conexion->prepare("DELETE FROM entradas WHERE id = ?");
        $stmt->bind_param("i", $id_entrada);
    } else {
        // USUARIO: Solo borra si el 'usuario_id' coincide con el suyo
        $stmt = $conexion->prepare("DELETE FROM entradas WHERE id = ? AND usuario_id = ?");
        $stmt->bind_param("ii", $id_entrada, $mi_id);
    }

    $stmt->execute();
}

// Redirección inteligente (Vuelve a donde estabas)
if (isset($_SERVER['HTTP_REFERER'])) {
    header("Location: " . $_SERVER['HTTP_REFERER']);
} else {
    header("Location: ../pages/dashboard.php");
}
?>

```
**editar_accion.php**
```php
<?php
session_start();
require_once '../config/conexion.php';

if (!isset($_SESSION['usuario_id'])) { header("Location: ../pages/index.php"); exit(); }

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $id = $_POST['id'];
    $emocion = $_POST['emocion'];
    $nota = $_POST['nota'];
    $intensidad = $_POST['intensidad']; // Nuevo campo
    $uid = $_SESSION['usuario_id'];
    
    $sql = "UPDATE entradas SET emocion = ?, nota = ?, intensidad = ? WHERE id = ? AND usuario_id = ?";
    $stmt = $conexion->prepare($sql);
    $stmt->bind_param("ssiii", $emocion, $nota, $intensidad, $id, $uid);
    
    $stmt->execute();
    header("Location: ../pages/dashboard.php");
}
?>

```
**guardar_entrada.php**
```php
<?php
// --- MODO DEPURACIÓN ACTIVADO ---
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();
require_once '../config/conexion.php';

// Verificar sesión
if (!isset($_SESSION['usuario_id'])) { 
    header("Location: ../pages/index.php"); 
    exit(); 
}

if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $uid = $_SESSION['usuario_id'];
    // RECIBIMOS ARRAY (Checkboxes)
    $emociones = $_POST["emocion"] ?? []; 
    $nota = trim($_POST["nota"]);
    $intensidad = $_POST["intensidad"] ?? 5; 

    // Si no llega nada (array vacío), error
    if (empty($emociones)) {
        header("Location: ../pages/dashboard.php?error=falta_emocion&nota=" . urlencode($nota));
        exit();
    }

    try {
        // Preparamos la consulta UNA sola vez
        $sql = "INSERT INTO entradas (usuario_id, emocion, nota, intensidad, fecha) VALUES (?, ?, ?, ?, NOW())";
        $stmt = $conexion->prepare($sql);
        
        if (!$stmt) {
            throw new Exception("Error al preparar SQL: " . $conexion->error);
        }

        // Iteramos sobre cada emoción seleccionada y guardamos
        // Si seleccionaste 3, se guardan 3 registros seguidos.
        foreach ($emociones as $una_emocion) {
            // "issi" -> id(int), emocion(string), nota(string), intensidad(int)
            $stmt->bind_param("issi", $uid, $una_emocion, $nota, $intensidad);
            if (!$stmt->execute()) {
                throw new Exception("Error al guardar '$una_emocion': " . $stmt->error);
            }
        }
        
        // Si todo salió bien
        header("Location: ../pages/dashboard.php?exito=1");

    } catch (Exception $e) {
        die("<div style='color:red; font-family:sans-serif; padding:20px; border:2px solid red; background:#fff;'>
                <h3>⚠️ Error al guardar:</h3>
                <p>" . $e->getMessage() . "</p>
             </div>");
    }
}
?>

```
## Módulo de Perfil y Administración
**actualizar_perfil.php**
```php
<?php
session_start();
require_once '../config/conexion.php';

if (!isset($_SESSION['usuario_id'])) { header("Location: ../pages/index.php"); exit(); }

$uid = $_SESSION['usuario_id'];

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    
    // --- 1. LÓGICA DE NOMBRE DE USUARIO ---
    if (isset($_POST['nuevo_nombre']) && !empty($_POST['nuevo_nombre'])) {
        $nuevo_nombre = trim($_POST['nuevo_nombre']);
        
        // Verificar si cambió
        if ($nuevo_nombre !== $_SESSION['usuario_nombre']) {
            
            // A. Verificar 24 horas (Seguridad extra backend)
            $stmt = $conexion->prepare("SELECT ultimo_cambio_nombre FROM usuarios WHERE id = ?");
            $stmt->bind_param("i", $uid);
            $stmt->execute();
            $last_change = $stmt->get_result()->fetch_assoc()['ultimo_cambio_nombre'];
            
            if ($last_change && (time() - strtotime($last_change) < 86400)) {
                header("Location: ../pages/configuracion.php?error=tiempo");
                exit();
            }

            // B. Verificar que sea único
            $check = $conexion->prepare("SELECT id FROM usuarios WHERE nombre = ? AND id != ?");
            $check->bind_param("si", $nuevo_nombre, $uid);
            $check->execute();
            
            if ($check->get_result()->num_rows > 0) {
                header("Location: ../pages/configuracion.php?error=existe");
                exit();
            }

            // C. Actualizar nombre y fecha
            $update = $conexion->prepare("UPDATE usuarios SET nombre = ?, ultimo_cambio_nombre = NOW() WHERE id = ?");
            $update->bind_param("si", $nuevo_nombre, $uid);
            $update->execute();
            
            $_SESSION['usuario_nombre'] = $nuevo_nombre; // Actualizar sesión
        }
    }

    // --- 2. LÓGICA DE CONTRASEÑA ---
    if (!empty($_POST['nueva_pass'])) {
        $pass1 = $_POST['nueva_pass'];
        $pass2 = $_POST['confirmar_pass'];
        
        if ($pass1 !== $pass2) {
            header("Location: ../pages/configuracion.php?error=pass");
            exit();
        }
        
        $pass_hash = password_hash($pass1, PASSWORD_DEFAULT);
        $update_pass = $conexion->prepare("UPDATE usuarios SET password = ? WHERE id = ?");
        $update_pass->bind_param("si", $pass_hash, $uid);
        $update_pass->execute();
    }

    header("Location: ../pages/configuracion.php?exito=1");
    exit();
}
?>

```
**cambiar_rol.php**
```php
<?php
session_start();
require_once 'conexion.php';

// 1. SEGURIDAD: ¿Quien hace la petición es Admin?
if (!isset($_SESSION['usuario_id'])) { header("Location: index.php"); exit(); }

$mi_id = $_SESSION['usuario_id'];
$check = $conexion->query("SELECT rol FROM usuarios WHERE id = $mi_id");
$mi_rol = $check->fetch_assoc()['rol'];

if ($mi_rol !== 'admin') {
    die("⛔ Acceso denegado.");
}

// 2. RECIBIR DATOS
if (isset($_GET['id']) && isset($_GET['rol'])) {
    $id_usuario_objetivo = $_GET['id'];
    $nuevo_rol = $_GET['rol'];

    // 3. REGLA DE SEGURIDAD (ANTI-SUICIDIO DIGITAL)
    // No permitimos que un admin se quite el rol a sí mismo
    if ($id_usuario_objetivo == $mi_id) {
        echo "<script>
                alert('⚠️ No puedes quitarte el rol de Admin a ti mismo.');
                window.location.href='admin.php';
              </script>";
        exit();
    }

    // 4. EJECUTAR EL CAMBIO
    // Solo permitimos roles válidos para evitar inyecciones raras
    if ($nuevo_rol == 'admin' || $nuevo_rol == 'user') {
        $stmt = $conexion->prepare("UPDATE usuarios SET rol = ? WHERE id = ?");
        $stmt->bind_param("si", $nuevo_rol, $id_usuario_objetivo);
        
        if ($stmt->execute()) {
            header("Location: admin.php"); // Éxito
        } else {
            echo "Error SQL: " . $conexion->error;
        }
    }
} else {
    header("Location: admin.php");
}
?>

```
## reporte